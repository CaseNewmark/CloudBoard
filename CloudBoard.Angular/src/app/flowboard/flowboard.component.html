<div class="toolbar-container">
    <toolbar></toolbar>
</div>
@if (!currentCloudBoard) {
<div class="grow h-full flex justify-center items-center">
    <i>No Cloudboard loaded yet..</i>
</div>
}
@else {
<div class="grow h-full flex flex-row overflow-hidden">
    <p-contextmenu #flowcontextmenu [model]="flowContextMenuItems" />
    <p-contextmenu #nodecontextmenu [model]="nodeContextMenuItems" />
    <f-flow class="grow" 
        fDraggable (contextmenu)="showFlowContextMenu($event)"
        (fSelectionChange)="onSelectionChange($event)"
        (fCreateConnection)="onConnectionAdded($event)">
        <f-canvas fZoom>
            <!-- Render all connections from the cloudboard data -->
            <f-connection-for-create fBehavior="floating"></f-connection-for-create>
            @for (connection of currentCloudBoard.connections; track $index) {
            <f-connection fType="segment" [fOutputId]="connection.fromConnectorId" [fInputId]="connection.toConnectorId">
            </f-connection>
            }

            <!-- Render all nodes from the cloudboard data -->
            @for (node of currentCloudBoard.nodes; track node.tempid) {
            <div fNode [fNodeId]="node.id"
                fDragHandle [fNodePosition]="node.position"
                (fNodePositionChange)="onNodePositionChanged($event, node)"
                (contextmenu)="showNodeContextMenu($event, node)">

                <!-- Dynamically render the correct component based on node type -->
                @switch (node.type) {
                    @case ('Note') {
                        <simple-note [node]="node"></simple-note>
                    }
                    @case ('Card') {
                        <card-node [node]="node"></card-node>
                    }
                    @case ('LinkCollection') {
                        <link-collection [node]="node"></link-collection>
                    }
                    @case ('Image') {
                        <image-node [node]="node"></image-node>
                    }
                    @case ('CodeBlock') {
                        <code-block [node]="node"></code-block>
                    }
                    @default {
                        <simple-note [node]="node"></simple-note>
                    }
                }

                @for (connector of node.connectors; track connector.tempid) {
                    @switch (connector.type.toString().toLowerCase()) {
                        @case ('in') {
                        <div fNodeInput [fInputId]="connector.id" class="connector left"></div>
                        }
                        @case ('out') {
                        <div fNodeOutput [fOutputId]="connector.id" class="connector right"></div>
                        }
                        @case ('inout') {
                        <div fNodeInput [fInputId]="connector.id" fNodeOutput [fOutputId]="connector.id" class="connector top"></div>
                        }
                    }
                }
            </div>
            }
        </f-canvas>
    </f-flow>
    <properties-panel 
        [(visible)]="propertiesPanelVisible" 
        [(nodeProperties)]="propertiesPanelNodeProperties">
    </properties-panel>
</div>
}